<div class="d-flex" style="min-height: 0; flex-grow: 1">

    <div class="container mt-3 mb-5">
        <div class="row">
            <div class="col-12">
                <nav class="mb-3">
                    <div class="nav nav-pills" id="nav-tab" role="tablist">
                        <button class="nav-link text-white active" id="nav-home-tab" data-bs-toggle="tab" data-bs-target="#nav-home" type="button" role="tab" aria-controls="nav-home" aria-selected="true">Flights</button>
                        <button class="nav-link text-white" id="nav-profile-tab" data-bs-toggle="tab" data-bs-target="#nav-profile" type="button" role="tab" aria-controls="nav-profile" aria-selected="false">ATC</button>
                        <button class="nav-link text-white" id="nav-contact-tab" data-bs-toggle="tab" data-bs-target="#nav-contact" type="button" role="tab" aria-controls="nav-contact" aria-selected="false">Contact</button>
                    </div>
                </nav>
                <div class="tab-content" id="nav-tabContent">
                    <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab">
                        <table class="small table table-dark table-bordered">
                            <thead>
                                <tr>
                                    <th>Callsign</th>
                                    <th>Pilot</th>
                                    <th>Status</th>
                                    <th colspan="2">Departure</th>
                                    <th colspan="2">Arrival</th>
                                </tr>
                            </thead>
                            <tbody id="flights" style="vertical-align: middle">
                                
                            </tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="nav-profile" role="tabpanel" aria-labelledby="nav-profile-tab">
                        <table class="small table table-dark table-bordered">
                            <thead>
                                <tr>
                                    <th>Callsign</th>
                                    <th>Position</th>
                                    <th>Frequency</th>
                                    <th>Name</th>
                                </tr>
                            </thead>
                            <tbody id="atc" style="vertical-align: middle">
                                
                            </tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="nav-contact" role="tabpanel" aria-labelledby="nav-contact-tab">...</div>
                </div>
            </div>
        </div>
    </div>

    {{> footer}}
</div>
<script>

$(document).ready(function() {

    airports = [];
    flights = [];
    manual = false;

    // Airports show everything
    filterName = null;
    filterCriteria = null;

    initialize();

    setInterval(
        async () => { 

            if(new Date().getSeconds() <= 5)
            {
                await refreshATC();
                flights = await refreshFlights(filterName, filterCriteria);
                updateInfobar();
                updateSigmet();
                setLayerOrder();
            }
            else
            {
                interpolateLoc();
            }
            
        }, 5 * 1000);
})

async function initialize()
{
    initializeMap(1);

    response = await fetch('/livedata/airports.json');
    airports = await response.json();
    flights = await refreshFlights(filterName, filterCriteria);
    eventsByAirport = await loadUpcomingEvents();

    initializeNexrad();
    initializeATC();
    initializeAirports();
    refreshATC();
    initializeInfobar();
    updateSigmet();

    refreshData();
}

async function refreshData()
{
    await refreshATC();
    flights = await refreshFlights();

    let html = '';
    $.each(flights, (idx, flight) => {

        [dep_airport, dep_point, dep_name, dep_city] = processAirport(flight.dep);
        [arr_airport, arr_point, arr_name, arr_city] = processAirport(flight.arr);
        let status = getStatus(flight);
        html += '<tr><td>'+flight.callsign+'</td><td><span class="me-2">'+flight.name+'</span>'+getBadge(flight.rating)+'</td><td><span>'+status.status+'</span></td><td style="text-align: center">'+flight.dep+'</td><td class="small">'+dep_name+'<br><span class="text-muted">'+dep_city+'</span></td><td style="text-align: center">'+flight.arr+'</td><td class="small">'+arr_name+'<br><span class="text-muted">'+arr_city+'</span></td></tr>';
    })
    $('#flights').html(html);

    html = '';
    $.each(sectors, (idx, sector) => {
        let index = getFirIndexByCallsign(sector.callsign);
        let firname = getCallsignByFir(firSearch(sector.callsign), index);
        html += '<tr><td>'+sector.callsign+'</td><td>'+firname+'</td><td>'+sector.freq+'</td><td>'+sector.name+'</td></tr>';
    })
    $.each(tracons, (idx, tracon) => {
        $.each(tracon.APP, (idx, app) => {
            html += '<tr><td>'+app.callsign+'</td><td>'+tracon.name+'</td><td>'+app.freq+'</td><td>'+app.name+'</td></tr>';
        })
        $.each(tracon.DEP, (idx, dep) => {
            html += '<tr><td>'+dep.callsign+'</td><td>'+tracon.name+'</td><td>'+dep.freq+'</td><td>'+dep.name+'</td></tr>';
        })
    })
    $.each(locals, (idx, local) => {
        if(local.loc.callsign)
        {
            var callsign = local.loc.callsign;
        }
        else
        {
            var callsign = local.loc.city
        }
        $.each(local.DEL, (idx, pos) => {
            html += '<tr><td>'+pos.callsign+'</td><td>'+callsign+' Delivery</td><td>'+pos.freq+'</td><td>'+pos.name+'</td></tr>';
        })
        $.each(local.GND, (idx, pos) => {
            html += '<tr><td>'+pos.callsign+'</td><td>'+callsign+' Ground</td><td>'+pos.freq+'</td><td>'+pos.name+'</td></tr>';
        })
        $.each(local.TWR, (idx, pos) => {
            html += '<tr><td>'+pos.callsign+'</td><td>'+callsign+' Tower</td><td>'+pos.freq+'</td><td>'+pos.name+'</td></tr>';
        })
    })
    $('#atc').html(html);

}
</script>